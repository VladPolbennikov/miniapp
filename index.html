<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      html, body {
        margin: 0; padding: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: var(--tg-theme-bg-color, #111);
        color: var(--tg-theme-text-color, #fff);
        height: 100%;
      }
      .wrap { display: flex; align-items: center; justify-content: center; height: 100%; padding: 24px; }
      button {
        font-size: 18px; padding: 14px 18px; border-radius: 12px; border: none;
        background: var(--tg-theme-button-color, #2ea6ff);
        color: var(--tg-theme-button-text-color, #fff); cursor: pointer;
      }
      button:active { transform: translateY(1px); }
      pre { white-space: pre-wrap; font-size: 12px; opacity: .8; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div>
        <button id="btn-premium">üíé –ü—Ä–µ–º–∏—É–º</button>
        <pre id="log"></pre>
      </div>
    </div>

    <script>
      const tg = window.Telegram.WebApp;
      tg.ready();
      tg.expand?.();

      const ENDPOINT = "https://pamelaenglishbot.ru/webapp"; // –≤–∞—à HTTPS —ç–Ω–¥–ø–æ–∏–Ω—Ç

      const logEl = document.getElementById('log');
      const log = (...args) => {
        console.log('[MiniApp]', ...args);
        logEl.textContent += args.map(a => {
          try { return typeof a === 'string' ? a : JSON.stringify(a); }
          catch { return String(a); }
        }).join(' ') + '\n';
      };

      window.addEventListener('error', e => log('window.onerror', e.message || e));
      window.addEventListener('unhandledrejection', e => log('unhandledrejection', e.reason || e));

      async function sendPremium() {
        log('click');
        try {
          const queryId = tg?.initDataUnsafe?.query_id;
          log('queryId:', queryId);

          if (!queryId) {
            tg.showAlert?.('query_id –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ Mini App –∏–∑ –º–µ–Ω—é –≤–ª–æ–∂–µ–Ω–∏–π/–º–µ–Ω—é —á–∞—Ç–∞.');
            return;
          }

          const payload = { query_id: queryId, command: 'premium' };
          log('fetch ‚Üí', ENDPOINT, payload);

          const resp = await fetch(ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });

          log('resp.status', resp.status);
          let data = null;
          try { data = await resp.json(); } catch { data = null; }
          log('resp.json', data);

          if (!resp.ok || (data && data.ok === false)) {
            const err = (data && data.error) || `HTTP ${resp.status}`;
            tg.showAlert?.('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + err);
            return;
          }

          tg.close?.();
        } catch (e) {
          log('fetch error', e);
          tg.showAlert?.('–û—à–∏–±–∫–∞: ' + (e?.message || e));
        }
      }

      document.getElementById('btn-premium').addEventListener('click', sendPremium);
    </script>
  </body>
</html>
